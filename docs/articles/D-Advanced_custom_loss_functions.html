<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="cito">
<title>Advanced: Custom loss functions and prediction intervals • cito</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced: Custom loss functions and prediction intervals">
<meta property="og:description" content="cito">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">cito</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/A-Introduction_to_cito.html">Introduction to cito</a>
    <a class="dropdown-item" href="../articles/B-Training_neural_networks.html">Training neural networks</a>
    <a class="dropdown-item" href="../articles/C-Example_Species_distribution_modeling.html">Example: (Multi-) Species distribution models with cito</a>
    <a class="dropdown-item" href="../articles/D-Advanced_custom_loss_functions.html">Advanced: Custom loss functions and prediction intervals</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/citoverse/cito/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Advanced: Custom loss functions and prediction intervals</h1>
                        <h4 data-toc-skip class="author">Maximilian
Pichler</h4>
            
            <h4 data-toc-skip class="date">2024-02-21</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/citoverse/cito/blob/HEAD/vignettes/D-Advanced_custom_loss_functions.Rmd" class="external-link"><code>vignettes/D-Advanced_custom_loss_functions.Rmd</code></a></small>
      <div class="d-none name"><code>D-Advanced_custom_loss_functions.Rmd</code></div>
    </div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      This vignette shows how cito can be used for advanced techniques
      such as custom loss functions.
    </div>
    
<div class="section level2">
<h2 id="custom-loss-functions">Custom loss functions<a class="anchor" aria-label="anchor" href="#custom-loss-functions"></a>
</h2>
<p>We can pass custom loss functions to cito. R variables/values that
are used within the loss function and that should be additionally
optimized must be passed to cito via the custom_parameters argument in
<code>dnn(...custom_parameters = list(name_of_parameter=...))</code></p>
<p>Examples:</p>
<ul>
<li>(Complex) likelihood functions</li>
<li>Advanced: Quantile regression</li>
</ul>
<p>Requirements: - Complex calculations have to be written in torch -
All functions/calls must have derivatives.</p>
<div class="section level3">
<h3 id="example-1-custom-likelihoodloss-functions">Example 1: Custom (likelihood/loss) functions<a class="anchor" aria-label="anchor" href="#example-1-custom-likelihoodloss-functions"></a>
</h3>
<p>Gaussian likelihood (already implemented, but still a nice example).
Custom parameters must be passed as a list to the custom_parameters
function. The names must match the names of the parameters in the custom
loss function. The values of the named custom parameters will be the
initial values. Cito will automatically convert them to torch
tensors:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://citoverse.github.io/cito/" class="external-link">cito</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span></span>
<span><span class="va">gaussian_ll</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">pred</span>, <span class="va">true</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">loss</span> <span class="op">=</span> <span class="op">-</span><span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/distr_normal.html" class="external-link">distr_normal</a></span><span class="op">(</span><span class="va">pred</span>, scale <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_exp.html" class="external-link">torch_exp</a></span><span class="op">(</span><span class="va">scale_par</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">log_prob</span><span class="op">(</span><span class="va">true</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">loss</span><span class="op">$</span><span class="fu">mean</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Simulate some data</span></span>
<span><span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">=</span> <span class="fl">2</span><span class="op">*</span><span class="va">X</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">200</span>, sd <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, Y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="../reference/dnn.html">dnn</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span>, data <span class="op">=</span> <span class="va">df</span>,</span>
<span>        loss <span class="op">=</span> <span class="va">gaussian_ll</span>, <span class="co"># custom function</span></span>
<span>        custom_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>scale_par <span class="op">=</span> <span class="fl">0.0</span><span class="op">)</span> <span class="co"># custom parameter that should be addtionally optimized</span></span>
<span>        <span class="op">)</span></span>
<span><span class="co">#&gt; Loss at epoch 1: 1.448659, lr: 0.01000</span></span></code></pre></div>
<p><img src="D/D-unnamed-chunk-2-1.png" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">#&gt; Loss at epoch 2: 1.256327, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 3: 1.159103, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 4: 1.105518, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 5: 1.073779, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 6: 1.048871, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 7: 1.027676, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 8: 1.008031, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 9: 0.990182, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 0.972489, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 11: 0.951989, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 12: 0.935877, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 13: 0.918649, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 14: 0.898347, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 15: 0.879806, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 16: 0.859411, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 17: 0.840322, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 18: 0.816451, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 19: 0.794193, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 0.769379, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 21: 0.744284, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 22: 0.724098, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 23: 0.697090, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 24: 0.675612, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 25: 0.658688, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 26: 0.638189, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 27: 0.626986, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 28: 0.612315, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 29: 0.598691, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 30: 0.596526, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 31: 0.587633, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 32: 0.587101, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 33: 0.603735, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 34: 0.598259, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 35: 0.579663, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 36: 0.593990, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 37: 0.580183, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 38: 0.584613, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 39: 0.580791, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 40: 0.583122, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 41: 0.587117, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 42: 0.579539, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 43: 0.571477, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 44: 0.576813, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 45: 0.569428, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 46: 0.590212, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 47: 0.596876, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 48: 0.589308, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 49: 0.577736, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 50: 0.581777, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 51: 0.578728, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 52: 0.611516, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 53: 0.598170, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 54: 0.579697, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 55: 0.575621, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 56: 0.584954, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 57: 0.573962, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 58: 0.589617, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 59: 0.586153, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 60: 0.582738, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 61: 0.590680, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 62: 0.582296, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 63: 0.574342, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 64: 0.582494, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 65: 0.572388, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 66: 0.590982, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 67: 0.568253, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 68: 0.578817, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 69: 0.577479, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 70: 0.576766, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 71: 0.592157, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 72: 0.591887, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 73: 0.571302, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 74: 0.580755, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 75: 0.575244, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 76: 0.570401, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 77: 0.583778, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 78: 0.596156, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 79: 0.578281, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 80: 0.592188, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 81: 0.590521, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 82: 0.601451, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 83: 0.574588, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 84: 0.598384, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 85: 0.573853, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 86: 0.569221, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 87: 0.569153, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 88: 0.578949, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 89: 0.576531, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 90: 0.588011, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 91: 0.578666, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 92: 0.573792, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 93: 0.586368, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 94: 0.572133, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 95: 0.585475, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 96: 0.585286, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 97: 0.609225, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 98: 0.587953, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 99: 0.580966, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 100: 0.568228, lr: 0.01000</span></span></code></pre>
<p>The optimized parameters are saved in the parameter field:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">parameter</span><span class="op">$</span><span class="va">scale_par</span><span class="op">)</span> <span class="co"># true scale parameter: 0.4!</span></span>
<span><span class="co">#&gt; [1] 0.4332361</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="example-2-quantile-regression">Example 2: Quantile regression<a class="anchor" aria-label="anchor" href="#example-2-quantile-regression"></a>
</h3>
<p>The bootstrapping approach provides confidence intervals, but not
prediction intervals. We could use likelihoods, such as the Gaussian
likelihood, to fit a constant prediction interval. However, we often use
loss functions, such as the mean squared error in ML/DL, which don’t
have an intrinsic parametrization for prediction intervals. We can
approximate prediction intervals with quantile regression, which has the
advantage of providing non-constant prediction intervals (for example
for heteroscedasticity):</p>
<p>Simulate data:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_in</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">S</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">1.</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="va">S</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span><span class="op">=</span><span class="va">S</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span><span class="op">=</span><span class="fl">0.0</span></span>
<span>  <span class="va">X</span> <span class="op">=</span> <span class="fu">mvtnorm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html" class="external-link">rmvnorm</a></span><span class="op">(</span><span class="va">n</span>, sigma <span class="op">=</span> <span class="va">S</span><span class="op">)</span></span>
<span>  <span class="va">X1</span> <span class="op">=</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">C</span> <span class="op">=</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">X2</span> <span class="op">=</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span></span>
<span>  <span class="va">Y</span> <span class="op">=</span> <span class="fl">1</span><span class="op">*</span><span class="va">X1</span> <span class="op">+</span> <span class="fl">0.1</span><span class="op">*</span><span class="va">X2</span> <span class="op">+</span> <span class="fl">0.0</span><span class="op">*</span><span class="va">C</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fl">0.3</span><span class="op">+</span><span class="fl">2</span><span class="op">*</span><span class="fl">1.8</span><span class="op">^</span><span class="op">(</span><span class="va">X1</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">Y</span>, X1 <span class="op">=</span> <span class="va">X1</span>, X2 <span class="op">=</span> <span class="va">X2</span>, C <span class="op">=</span> <span class="va">C</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu">sim_in</span><span class="op">(</span><span class="fl">500L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X1</span>, <span class="va">data</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span></span></code></pre></div>
<p><img src="D/D-unnamed-chunk-4-1.png" style="display: block; margin: auto;"></p>
<p>The variance increases with higher feature values</p>
<p>Quantile Regression:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">q1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html" class="external-link">torch_tensor</a></span><span class="op">(</span><span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="va">q2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html" class="external-link">torch_tensor</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">q3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html" class="external-link">torch_tensor</a></span><span class="op">(</span><span class="fl">0.95</span><span class="op">)</span></span>
<span><span class="va">loss_func</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">pred</span>, <span class="va">true</span>,<span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">l1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_max.html" class="external-link">torch_max</a></span><span class="op">(</span><span class="va">q1</span><span class="op">*</span><span class="op">(</span><span class="va">true</span><span class="op">[</span>,<span class="fl">1</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">-</span><span class="va">pred</span><span class="op">[</span>,<span class="fl">1</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span>, other <span class="op">=</span> <span class="op">(</span><span class="fl">1.0</span><span class="op">-</span><span class="va">q1</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">pred</span><span class="op">[</span>,<span class="fl">1</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">-</span><span class="va">true</span><span class="op">[</span>,<span class="fl">1</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">l2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_max.html" class="external-link">torch_max</a></span><span class="op">(</span><span class="va">q2</span><span class="op">*</span><span class="op">(</span><span class="va">true</span><span class="op">[</span>,<span class="fl">2</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">-</span><span class="va">pred</span><span class="op">[</span>,<span class="fl">2</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span>, other <span class="op">=</span> <span class="op">(</span><span class="fl">1.0</span><span class="op">-</span><span class="va">q2</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">pred</span><span class="op">[</span>,<span class="fl">2</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">-</span><span class="va">true</span><span class="op">[</span>,<span class="fl">2</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">l3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_max.html" class="external-link">torch_max</a></span><span class="op">(</span><span class="va">q3</span><span class="op">*</span><span class="op">(</span><span class="va">true</span><span class="op">[</span>,<span class="fl">3</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">-</span><span class="va">pred</span><span class="op">[</span>,<span class="fl">3</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span>, other <span class="op">=</span> <span class="op">(</span><span class="fl">1.0</span><span class="op">-</span><span class="va">q3</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">pred</span><span class="op">[</span>,<span class="fl">3</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">-</span><span class="va">true</span><span class="op">[</span>,<span class="fl">3</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">l1</span><span class="op">+</span><span class="va">l2</span><span class="op">+</span><span class="va">l3</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="../reference/dnn.html">dnn</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">Y</span>, <span class="va">Y</span><span class="op">)</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">data</span>,</span>
<span>        lr <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>        loss <span class="op">=</span> <span class="va">loss_func</span>,</span>
<span>        lambda <span class="op">=</span> <span class="fl">0.000</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>        epochs <span class="op">=</span> <span class="fl">70L</span>, hidden <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30L</span>, <span class="fl">30L</span><span class="op">)</span>,</span>
<span>        activation <span class="op">=</span> <span class="st">"selu"</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loss at epoch 1: 5.408019, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 2: 5.333291, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 3: 5.255817, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 4: 5.173627, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 5: 5.084182, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 6: 4.985171, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 7: 4.874483, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 8: 4.750940, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 9: 4.612569, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 4.463618, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 11: 4.303880, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 12: 4.132645, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 13: 3.958434, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 14: 3.796573, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 15: 3.653077, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 16: 3.526174, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 17: 3.420648, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 18: 3.327523, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 19: 3.249835, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 3.184629, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 21: 3.130454, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 22: 3.087324, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 23: 3.051507, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 24: 3.020186, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 25: 2.993808, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 26: 2.969885, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 27: 2.949128, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 28: 2.931357, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 29: 2.918594, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 30: 2.906851, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 31: 2.896184, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 32: 2.889005, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 33: 2.882415, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 34: 2.876860, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 35: 2.870946, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 36: 2.867113, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 37: 2.862620, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 38: 2.858537, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 39: 2.855360, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 40: 2.852441, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 41: 2.849163, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 42: 2.845885, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 43: 2.843100, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 44: 2.841253, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 45: 2.837898, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 46: 2.835108, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 47: 2.833399, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 48: 2.830339, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 49: 2.828214, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 50: 2.826396, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 51: 2.824593, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 52: 2.822212, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 53: 2.820205, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 54: 2.818298, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 55: 2.816402, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 56: 2.815773, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 57: 2.813069, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 58: 2.812088, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 59: 2.809517, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 60: 2.808090, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 61: 2.807289, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 62: 2.805554, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 63: 2.803404, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 64: 2.801963, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 65: 2.800906, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 66: 2.798794, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 67: 2.797041, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 68: 2.795433, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 69: 2.794709, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 70: 2.793144, lr: 0.01000</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X1</span>, <span class="va">data</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/smooth.spline.html" class="external-link">smooth.spline</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, spar <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/smooth.spline.html" class="external-link">smooth.spline</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>, spar <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/smooth.spline.html" class="external-link">smooth.spline</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, spar <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="D/D-unnamed-chunk-5-1.png" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="example-3-using-cito-for-optimization-active-learning">Example 3: Using cito for optimization / active learning<a class="anchor" aria-label="anchor" href="#example-3-using-cito-for-optimization-active-learning"></a>
</h3>
<p>Neural networks can be used in an unconventional way to optimize
arbitrary functions (which is sometimes called active learning, it is
related to reinforcement learning) - the only prerequiste is that the
analytic derivative of the function using torch must be available. We
provide the function to be optimized as a series of Torch operations.
First, our model will predict the parameters (based on noise, the inputs
don’t matter) which are passed to the custom loss function and then we
will then use the model function (which we optimize) to compute the loss
and return it to the optimizer. In that way we overfit to the noisy
inputs and the DNN will learn to predict the optimal set of parameters -
independent of the input.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">=</span> <span class="fl">2</span><span class="op">*</span><span class="va">X</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">200</span>, sd <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, Y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Function we want to optimize (linear model)</span></span>
<span><span class="va">Xt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html" class="external-link">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Yt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html" class="external-link">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_lm</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="va">Xt</span><span class="op">$</span><span class="fu">matmul</span><span class="op">(</span><span class="va">par</span><span class="op">[</span>,<span class="fl">1</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">loss</span> <span class="op">=</span> <span class="op">-</span><span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/distr_normal.html" class="external-link">distr_normal</a></span><span class="op">(</span><span class="va">pred</span>, scale <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_exp.html" class="external-link">torch_exp</a></span><span class="op">(</span><span class="va">par</span><span class="op">[</span>,<span class="fl">2</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">log_prob</span><span class="op">(</span><span class="va">Yt</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">loss</span><span class="op">$</span><span class="fu">mean</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">custom_loss</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">pred</span>, <span class="va">true</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_zeros.html" class="external-link">torch_zeros</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span><span class="op">)</span> <span class="co"># disable loss calculation</span></span>
<span>  <span class="va">loss</span> <span class="op">=</span> <span class="fu">model_lm</span><span class="op">(</span><span class="va">pred</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">loss</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># X and Y values don't matter, number of columns in Y has to match the number of parameters we want to optimize</span></span>
<span><span class="va">noise</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">300</span><span class="op">*</span><span class="fl">5</span><span class="op">)</span>, <span class="fl">300</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">noise_y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">300</span><span class="op">*</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">300</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y1 <span class="op">=</span> <span class="va">noise_y</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, y2 <span class="op">=</span> <span class="va">noise_y</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="va">noise</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="../reference/dnn.html">dnn</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">y1</span>, <span class="va">y2</span><span class="op">)</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">df</span>, loss <span class="op">=</span> <span class="va">custom_loss</span>, batchsize <span class="op">=</span> <span class="fl">1L</span>, epochs <span class="op">=</span> <span class="fl">20L</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="D/D-unnamed-chunk-6-1.png" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Effect:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2.02776</span></span>
<span><span class="co"># SD</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3864421</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Christian Amesöder, Maximilian Pichler.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
